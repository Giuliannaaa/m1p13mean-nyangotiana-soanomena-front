<div class="note-boutique-wrapper glass-container">
    <div class="note-header">
        <h3 class="section-title">Évaluer cette boutique</h3>
        <p class="section-subtitle">Votre avis nous aide à nous améliorer</p>
    </div>

    @if (canRate) {
    <div class="rating-input-section">
        <div class="stars-label">Votre note :</div>
        <div class="interactive-stars">
            @for (star of [1,2,3,4,5]; track star) {
            <button type="button" (click)="setRating(star)" class="star-btn" [class.star-active]="userRating >= star"
                [title]="'Noter ' + star + ' étoile(s)'">
                <svg viewBox="0 0 24 24" class="star-icon">
                    <path
                        d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z" />
                </svg>
            </button>
            }
            @if (userRating > 0) {
            <span class="rating-badge">{{ userRating }}/5</span>
            }
        </div>
    </div>

    <div class="comment-input-section">
        <label for="review-comment" class="field-label">Commentaire (optionnel)</label>
        <div class="textarea-wrapper">
            <textarea id="review-comment" [(ngModel)]="comment"
                placeholder="Partagez votre expérience avec cette boutique..." class="glass-textarea"
                rows="3"></textarea>
        </div>
    </div>

    <div class="actions-footer">
        <button (click)="envoyer()" [disabled]="userRating === 0 || isLoading" class="btn-pill btn-pill-primary"
            [class.loading]="isLoading">
            <span class="btn-content">
                @if (isLoading) {
                <span class="spinner-small"></span>
                }
                {{ isLoading ? 'Envoi...' : (hasRating ? 'Mettre à jour mon avis' : 'Envoyer mon avis') }}
            </span>
        </button>

        @if (hasRating) {
        <button (click)="supprimer()" [disabled]="isLoading" class="btn-pill btn-pill-danger-outline">
            Supprimer
        </button>
        }
    </div>
    } @else {
    <div class="login-notice-section">
        <p class="notice-text">Vous devez être connecté en tant qu'acheteur pour évaluer cette boutique.</p>
    </div>
    }

    @if (successMessage) {
    <div class="alert alert-success mt-4">
        <img src="/img/svg/icon-check-circle.svg" alt="Success" class="alert-icon">
        <span>{{ successMessage }}</span>
    </div>
    }

    <div class="reviews-list-section">
        <h4 class="sub-section-title">Avis des clients</h4>

        @if (avis.length > 0) {
        <div class="reviews-scroll-area">
            @for (item of avis; track item._id) {
            <div class="review-card">
                <div class="review-header">
                    <div class="reviewer-info">
                        <div class="reviewer-avatar">
                            {{ (item.acheteur_id?.firstname?.charAt(0) || 'U') }}
                        </div>
                        <div class="reviewer-meta">
                            <span class="reviewer-name">{{ item.acheteur_id?.firstname }} {{ item.acheteur_id?.lastname
                                }}</span>
                            <span class="review-date">{{ item.createdAt | date:'dd/MM/yyyy' }}</span>
                        </div>
                    </div>
                    <div class="review-rating">
                        @for (star of [1,2,3,4,5]; track star) {
                        <svg viewBox="0 0 24 24" class="star-icon-small" [class.active]="item.rating >= star">
                            <path
                                d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z" />
                        </svg>
                        }
                    </div>
                </div>
                @if (item.comment) {
                <div class="review-body">
                    <p class="review-text">"{{ item.comment }}"</p>
                </div>
                }
            </div>
            }
        </div>
        } @else {
        <div class="empty-reviews">
            <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAYAAABXAvmHAAAACXBIWXMAAAsTAAALEwEAmpwYAAAEeUlEQVR4nO2Z228VVRTGGzDIq6+a+GjkjzAoCW+amCDKxYhCQRTwVrRKuZRCS7mUlnJqsZRSbG05WMXKpQe5YwkVEFAeFGL8V35kJd8kk8menjOHxZnGOMnOpCens3/fmm+tvfY+dXX/X/+BC3gROA38BTzU/T5wD7gN/AZMAleACaATeKFuJlzAPOCBoA34d+CWoG8A14Frgr8InAfOAT8Bz80EASXgb+BuBvizwBmgdSYI+Cdj5M/KbuPAWC1B5wIfAseBSwK7APxbJfyPGnuBfcAuoAF4BXjKG/55TWwg3wK9QAE4qM+qgf8eOAxsB5o1WoDdQCPwjGfkJzTx10BPDL4b6BN0VvgRywGBbwO2AluAzcBOiXj8NwF8ClxOgT8AdOnzn/W9cvBFRT4NvgnYBLQDCzwEWLUYngbeavp+oENeNk/vkRXa5e02RXWHbLK9DPxX+rzBQ4Al6KEaw3+p0e4h4H4O8I3AF/ZsLwF5wH/uJeDPFPhjwBRwJ9bvRJXoVyXzJa0Vv6iSWT6dUhthCT2m/GoLwG+04HgJCEXeA76ocno0AG+L2l4PAX+k2OaGE/ww0B+A/8ws6SUg5PkjWrQ84FsC8J94VaF7NUrYjQn4jz0F5AH/kT3fS0Ae8Bvs+R4C7uYEv95lwyMBIfg+7XNvqqRGiXxVTV2UyKVYIo8nEnkUGJDgJPw6C5CHgDspkfeAHwYGgW8C8LZ52uElIGSba07wA2rVk/AfeAoIeb5HNd8DflMAfq3N49VO1yJh1yXg37d5vATkAb/G5vEQcLsG8Otl00G1HJEFz6kPWwzMqVbArScMv0uwlxN76QmNknLLhL1erYAQ/EFNOhlL4JI28CfVrLVMA2+jL1YAkvDxJvCk7ucVtNlZBYQiPx38WGyRSot8Fnh73gkdqtkpR2MWATdTbHOhDPyQFqg028ThR+X1kQB8v45grNx+pxJsIl7NIiDk+Q5BTwfflJKwcc+PquLUa/TG4G0ruwJ4W6NbiT6s/yuf2NpxeZbK9oRtugS+ClipUUjALweWiWNAb+UH4LVKBXjW+cGE50ckwMDfA97VSMIvk9h+vd2hilZqCfBcpMYDCdsrARH4OwH4thh8r+5HKxEw5bzCllKqTUECQvCtCfiCxolKBFyV97zagzMppbI7YJulGi0J+OicqliJgOPakXnAr9bReqXwS4C3NJpj8J26H65EwBpN6gFfr4PiZJ1fEbDNUoG/qV5osazUqRJub6OpEgFPq+YecoBfpTUlvsK2piTsTgkw8DeARZq3Q1tcO9pcWFaARDyrsjWkzrShSviVug/F2oMeCQhVm2YJWKSxTfBdWpkz9URzFKWC3khRIAOarKDXu1vR26rK1SCRa2MLVZMWolG1B90qFPE6HyVsq34liuCj6L9cl+clQUUFIdpeJuGjhI1ss0ffWZ0rvATMkr1GJKAc/H6JrM9knSd9AfMFa7YwEeZt+9vsZMP2HSbMxLyUN2/wsp9T9QO3ed2OMW2vYMOib9XORAZ/cn0E4jjaQxvx0jMAAAAASUVORK5CYII=" alt="no-data-availible" class="empty-icon">
            <p>Aucun avis pour le moment. Soyez le premier à donner le vôtre !</p>
        </div>
        }
    </div>
</div>