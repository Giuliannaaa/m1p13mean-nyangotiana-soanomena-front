<div class="achat-list-container">
  <div class="list-header">
    <h1>Liste des Achats</h1>
  </div>

  <!-- Filters -->
  <div class="filter-card">
    <h3>Filtrer par boutique</h3>
    <div class="filter-grid">
      <select [(ngModel)]="boutique_selectionnee" (change)="filterByBoutique()" class="form-select">
        <option value="">-- Toutes les boutiques --</option>
        <option *ngFor="let boutique of boutiques" [value]="boutique._id">
          {{ boutique.name }}
        </option>
      </select>

      <button (click)="resetFilter()" class="btn-reset">
        Réinitialiser
      </button>
    </div>

    <div *ngIf="isFiltering" class="filter-stats">
      <strong>Achats filtrés :</strong> {{ filteredAchats.length }} résultat(s) / {{ achats.length }} total
    </div>
  </div>

  <!-- Empty State -->
  <div *ngIf="filteredAchats.length === 0" class="empty-state">
    <p>{{ isFiltering ? 'Aucun achat pour cette boutique' : 'Aucun achat pour le moment' }}</p>
  </div>

  <!-- Achat Cards -->
  <div *ngFor="let achat of filteredAchats" class="achat-card">
    <!-- Header -->
    <div class="achat-header">
      <div class="achat-info">
        <div class="info-item">
          <span class="info-label">Date</span>
          <span class="info-value">{{ achat.createdAt | date:'dd MMM yyyy HH:mm' }}</span>
        </div>
        <div class="info-item">
          <span class="info-label">Boutique</span>
          <span class="info-value">{{ getNomBoutique(achat) }}</span>
        </div>
      </div>
      <span class="status-badge" [ngClass]="'status-' + (achat.status?.toLowerCase() || 'en_attente')">
        {{ achat.status || 'EN ATTENTE' }}
      </span>
    </div>

    <!-- Items Table -->
    <table class="modern-table">
      <thead>
        <tr>
          <th style="width: 80px;">Image</th>
          <th>Produit</th>
          <th style="text-align: center;">Qté</th>
          <th style="text-align: right;">Prix Unitaire</th>
          <th style="text-align: right;">Sous-total</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let item of achat.items">
          <td>
            <img [src]="getProductImage(item)" alt="Produit" class="item-thumb"
              onerror="this.src='/img/placeholder.png'" />
          </td>
          <td><span class="item-name">{{ item.nom_prod || 'Produit inconnu' }}</span></td>
          <td style="text-align: center;">{{ item.quantity }}</td>
          <td style="text-align: right;">
            {{ item.prix_unitaire?.$numberDecimal
            ? (item.prix_unitaire.$numberDecimal | number:'1.0-0')
            : (item.prix_unitaire | number:'1.0-0') }} Ar
          </td>
          <td style="text-align: right; font-weight: 600;">
            {{ (item.quantity * (item.prix_unitaire?.$numberDecimal
            ? parseFloat(item.prix_unitaire.$numberDecimal)
            : item.prix_unitaire)) | number:'1.0-0' }} Ar
          </td>
        </tr>
      </tbody>
    </table>

    <!-- Footer -->
    <div class="achat-footer">
      <div class="achat-actions">
        <ng-container *ngFor="let nextStatus of getTransitions(achat.status, achat.avec_livraison)">
          <button (click)="updateStatus(achat._id, nextStatus)" class="btn-action"
            [style.background-color]="getStatusActionColor(nextStatus)">
            {{ getStatusActionLabel(nextStatus) }}
          </button>
        </ng-container>

        <button (click)="deleteAchat(achat._id)" class="btn-action btn-outline-danger">
          Supprimer
        </button>
      </div>

      <div class="totals-group">
        <div class="total-row">
          <span>Total articles</span>
          <span>{{ achat.total_achat | number:'1.0-0' }} Ar</span>
        </div>
        <div *ngIf="achat.reduction > 0" class="total-row" style="color: #16a34a;">
          <span>Réduction</span>
          <span>-{{ achat.reduction | number:'1.0-0' }} Ar</span>
        </div>
        <div *ngIf="achat.avec_livraison" class="total-row" style="color: #2563eb;">
          <span>Frais de livraison</span>
          <span>+{{ achat.frais_livraison | number:'1.0-0' }} Ar</span>
        </div>
        <div class="total-row grand-total">
          <span>Total Final</span>
          <span>{{ achat.total_reel | number:'1.0-0' }} Ar</span>
        </div>
      </div>
    </div>
  </div>
</div>