<div class="produit-detail-wrapper">
  <!-- Chargement -->
  @if (isLoading) {
  <div class="loader-container">
    <div class="loader"></div>
  </div>
  }

  <!-- Produit trouvé -->
  @if (produit && !isLoading) {
  <div class="glass-card main-detail-card">
    <!-- Breadcrumb -->
    <nav class="breadcrumb">
      <a routerLink="/produits">Produits</a>
      <span class="separator">/</span>
      <span class="current">{{ produit.nom_prod }}</span>
    </nav>

    <div class="main-content-grid">
      <!-- Image du produit -->
      <div class="image-section">
        <div class="image-container">
          @if (produit.image_Url) {
          <img [src]="getImageUrl(produit.image_Url)" [alt]="produit.nom_prod" class="product-image" />
          } @else {
          <div class="image-placeholder">
            <img src="/img/png/elementor-placeholder-image.png" alt="No image">
            <span>Pas d'image disponible</span>
          </div>
          }
        </div>
      </div>

      <!-- Infos du produit -->
      <div class="info-section">
        <h1 class="product-title">{{ produit.nom_prod }}</h1>

        <div class="price-box">
          <span class="price-label">Prix unitaire</span>
          <p class="price-value">
            {{ produit.prix_unitaire?.$numberDecimal || produit.prix_unitaire || 0 | number:'1.0-0' }} Ar
          </p>
        </div>

        <div class="stock-section">
          <span class="stock-badge" [style.background-color]="getStockColor()">
            {{ getStockStatus() }}
          </span>
        </div>

        <div class="description-box">
          <span class="section-label">Description</span>
          <p class="description-text">
            {{ produit.descriptions || 'Aucune description détaillée n\'est disponible pour ce produit.' }}
          </p>
        </div>

        @if (produit.store_id) {
        <div class="store-card">
          <span class="section-label">Vendu par</span>
          <a [routerLink]="['/boutiques', produit.store_id._id || produit.store_id]" class="store-link">
            {{ produit.store_id.name || produit.store_id }}
          </a>
        </div>
        }

        <div class="actions-group">
          <button (click)="onAddToPanier()" [disabled]="!produit.stock_etat"
            class="btn-pill btn-pill-primary btn-pill-large">
            <img src="/img/svg/icon-cart-add.svg" alt="" class="btn-icon">
            {{ produit.stock_etat ? 'Ajouter au panier' : 'Rupture de stock' }}
          </button>

          <button [routerLink]="['/achats/ajouter', produit._id]" [disabled]="!produit.stock_etat"
            class="btn-pill btn-pill-dark btn-pill-large">
            Acheter maintenant
          </button>
        </div>

        <!-- Signalement Toggle (Seulement pour les acheteurs) -->
        @if (isAcheteur) {
        <div class="report-trigger-wrapper">
          <button (click)="toggleReportModal()" class="btn-report">
            <img src="/img/svg/icon-alert.svg" alt="" class="report-icon">
            Signaler un problème
          </button>
        </div>
        }
      </div>
    </div>

    <!-- Modal de Signalement (Placé ici pour le contexte, mais masqué par défaut) -->
    @if (showReportModal && isAcheteur) {
    <div class="report-modal-overlay" (click)="toggleReportModal()">
      <div class="report-modal-content" (click)="$event.stopPropagation()">
        <button class="btn-close-modal" (click)="toggleReportModal()">&times;</button>
        <app-signaler-produit [produitId]="produit._id"></app-signaler-produit>
      </div>
    </div>
    }
  </div>
  }

  <!-- Produit non trouvé -->
  @if (!produit && !isLoading) {
  <div class="glass-card empty-state-card text-center">
    <img src="/img/svg/icon-bag.svg" alt="" class="mb-4 opacity-50" width="64">
    <h2 class="text-xl font-bold mb-2">Produit non trouvé</h2>
    <p class="text-white/50 mb-6">Le produit que vous recherchez n'existe pas ou a été retiré.</p>
    <a routerLink="/produits" class="btn-pill btn-pill-primary">
      Retour à la boutique
    </a>
  </div>
  }
</div>