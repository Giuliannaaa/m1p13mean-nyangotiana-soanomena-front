<div class="produit-list-container">
    <div class="list-header">
        <h1>Nos Produits</h1>
        <button *ngIf="isAdmin" routerLink="/produits/ajouter" class="btn-primary">Ajouter un produit</button>
        @if (isAcheteur) {
        <a routerLink="/mes-signalements" class="btn-primary">Mes signalements</a>
        }
    </div>
    <!-- FILTER SECTION (Unified) -->
    <div class="glass-card filters-container">
        <!-- Search Bar -->
        <div class="filters-header">
            <div class="search-group">
                <svg xmlns="http://www.w3.org/2000/svg" class="search-icon" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd"
                        d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z"
                        clip-rule="evenodd" />
                </svg>
                <input type="text" [(ngModel)]="searchText" (keyup)="filterProduits()" class="search-input"
                    id="search-input" placeholder="Rechercher un produit (nom, description, boutique)..." />
            </div>
            <p *ngIf="searchText" style="margin-top: 0.5rem; color: var(--text-muted); font-size: 0.85rem;">
                Résultats pour: <strong class="text-white">"{{ searchText }}"</strong>
            </p>
        </div>

        <!-- Advanced Filters Grid -->
        <div class="filters-actions">
            <!-- Category Filter -->
            <div class="filter-group">
                <label for="category-filter">Catégorie</label>
                <select id="category-filter" [(ngModel)]="filtre_special" (change)="filterProduits()"
                    class="filter-select">
                    <option value="">Toutes les catégories</option>
                    <option value="tous">Tous les produits</option>
                    <option value="nouveau">Nouveaux produits</option>
                    <option value="populaire">Produits populaires</option>
                    <option value="promo">Produits en promotion</option>
                    <option value="bestseller">Best-sellers</option>
                </select>
            </div>

            <!-- Shop Filter -->
            <div class="filter-group">
                <label for="boutique-filter">Boutique</label>
                <select id="boutique-filter" [(ngModel)]="boutique_selectionnee" (change)="filterProduits()"
                    class="filter-select">
                    <option value="">Toutes les boutiques</option>
                    <option *ngFor="let boutique of boutiques" [value]="boutique._id || ''">
                        {{ boutique.name }}
                    </option>
                </select>
            </div>

            <!-- Price Filter -->
            <div class="filter-group">
                <label>Prix : <span style="color: #fbbf24;">{{ prix_min | number:'1.0-0' }} Ar - {{ prix_max |
                        number:'1.0-0' }} Ar</span></label>
                <div class="price-range-container">
                    <div class="range-inputs">
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <span style="font-size: 0.8rem; color: var(--text-muted); width: 30px;">Min</span>
                            <input type="range" [(ngModel)]="prix_min" (change)="filterProduits()" [min]="0"
                                [max]="prix_max_range" class="modern-range" />
                        </div>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <span style="font-size: 0.8rem; color: var(--text-muted); width: 30px;">Max</span>
                            <input type="range" [(ngModel)]="prix_max" (change)="filterProduits()" [min]="0"
                                [max]="prix_max_range" class="modern-range" />
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Footer -->
        <div class="filter-actions">
            <button (click)="resetFilter()" class="btn-icon-reset">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                </svg>
            </button>

            <div class="results-count">
                <span *ngIf="!isLoadingSpecial">
                    {{ filteredProduits.length }} produit(s) trouvé(s)
                </span>
                <span *ngIf="isLoadingSpecial">Chargement...</span>
            </div>
        </div>
    </div>

    <!-- No Results State -->
    <div *ngIf="filteredProduits.length === 0" class="no-results">
        <p>
            {{ isFiltering || searchText ? 'Aucun produit ne correspond à vos critères de recherche.' : 'Aucun produit
            disponible pour le moment.' }}
        </p>
    </div>

    <!-- Tableau des produits -->
    <div class="glass-card overflow-hidden" *ngIf="filteredProduits.length > 0">
        <table class="modern-table">
            <thead>
                <tr>
                    <th>Image</th>
                    <th>Nom</th>
                    <th>Boutique</th>
                    <th>Description</th>
                    <th>Prix</th>
                    <th>Stock</th>
                    <th>Type</th>
                    <th>Livraison</th>
                    <th *ngIf="isAdmin || isAcheteur">Actions</th>
                </tr>
            </thead>

            <tbody>
                @for (produit of filteredProduits; track produit._id) {
                <tr>
                    <td class="td-image" style="position: relative;">
                        <img [src]="produit.image_Url ? ('http://localhost:5000/' + produit.image_Url) : 'img/png/elementor-placeholder-image.png'"
                            alt="{{ produit.nom_prod }}" class="product-thumb" />

                        <!-- AFFICHER PLUSIEURS BADGES -->
                        <div
                            style="position: absolute; top: 5px; right: 5px; display: flex; flex-direction: column; gap: 3px;">
                            @for (badge of getProductBadges(produit); track badge.text) {
                            <span style="
                                    background-color: {{ badge.color }}; 
                                    color: {{ badge.color === '#ffc107' ? 'black' : 'white' }}; 
                                    padding: 2px 6px; 
                                    border-radius: 3px; 
                                    font-size: 10px; 
                                    font-weight: bold;
                                    text-shadow: 0 1px 2px rgba(0,0,0,0.2);
                                    white-space: nowrap;
                                ">
                                {{ badge.text }}
                            </span>
                            }
                        </div>
                    </td>
                    <td class="font-bold">
                        <a [routerLink]="['/produits', produit._id]" style="color: #007bff; text-decoration: none;">
                            {{ produit.nom_prod }}
                        </a>
                    </td>
                    <td>{{ produit.store_id?.name || 'Boutique inconnue' }}</td>
                    <td class="td-desc">{{ produit.descriptions }}</td>
                    <td class="price-cell">
                        {{ produit.prix_unitaire.$numberDecimal | number:'1.0-0' }} Ar
                    </td>
                    <td>
                        <span class="badge" [ngClass]="produit.stock_etat ? 'badge-success' : 'badge-danger'">
                            {{ produit.stock_etat ? 'Disponible' : 'Rupture' }}
                        </span>
                    </td>
                    <td>{{ produit.type_produit }}</td>
                    <td>{{ produit.livraison?.disponibilite ? 'Oui' : 'Non' }}</td>
                    <td *ngIf="isAdmin" class="actions-cell">
                        <button [routerLink]="['/produits/modifier', produit._id]" class="btn-icon" title="Modifier">
                            <img src="/img/svg/icon-update.svg" alt="Modifier">
                        </button>
                        <button (click)="deleteProduit(produit._id)" class="btn-icon btn-delete" title="Supprimer">
                            <img src="/img/svg/icon-delete.svg" alt="Supprimer">
                        </button>
                    </td>
                    <td *ngIf="isAcheteur">
                        <button (click)="addToPanier(produit)" class="btn-icon-buy" title="Ajouter au Panier">
                            <img src="/img/svg/icon-cart.svg" alt="Ajouter au Panier">
                        </button>
                    </td>
                </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<script src=""></script>