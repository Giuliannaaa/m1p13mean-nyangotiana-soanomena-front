<div class="produit-list-container">
    <div class="list-header">
        <h1>Nos Produits</h1>
        <button *ngIf="isAdmin" routerLink="/produits/ajouter" class="btn-primary">Ajouter un produit</button>
    </div>
    @if (isAcheteur) {
        <a routerLink="/mes-signalements" class="nav-link">Mes signalements</a>
    }
    <!-- Section de filtrage (Spécial + Boutique + Prix) -->
    <div style="margin-bottom: 20px; padding: 15px; border-radius: 5px; border: 1px solid #ddd;">
        <h3 style="margin-top: 0;">Filtres</h3>
        
        <!-- Filtre Spécial (Nouveau, Populaire, etc.) -->
        <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 8px; font-weight: bold;">Catégorie</label>
            <select 
                [(ngModel)]="filtre_special" 
                (change)="filterProduits()"
                style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; width: 100%; max-width: 300px;"
            >
                <option value="tous">Tous les produits</option>
                <option value="nouveau">Nouveaux produits</option>
                <option value="populaire">Produits populaires</option>
                <option value="promo">Produits en promotion</option>
                <option value="bestseller">Best-sellers</option>
            </select>
        </div>

        <!-- Filtre Boutique -->
        <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 8px; font-weight: bold;">Boutique</label>
            <select 
                [(ngModel)]="boutique_selectionnee" 
                (change)="filterProduits()"
                style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; width: 100%; max-width: 300px;"
            >
                <option value="">-- Toutes les boutiques --</option>
                <option *ngFor="let boutique of boutiques" [value]="boutique._id">
                    {{ boutique.name }}
                </option>
            </select>
        </div>

        <!-- Filtre Prix -->
        <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 8px; font-weight: bold;">
                Prix : {{ prix_min | number:'1.0-0' }} Ar - {{ prix_max | number:'1.0-0' }} Ar
            </label>
            
            <!-- Slider Prix Min -->
            <div style="margin-bottom: 10px;">
                <label style="display: block; font-size: 12px; color: #666; margin-bottom: 5px;">Prix minimum</label>
                <input 
                    type="range" 
                    [(ngModel)]="prix_min" 
                    (change)="filterProduits()"
                    [min]="0" 
                    [max]="prix_max_range"
                    style="width: 100%; max-width: 300px;"
                />
                <span style="font-size: 12px; color: #666;">{{ prix_min | number:'1.0-0' }} Ar</span>
            </div>
            
            <!-- Slider Prix Max -->
            <div style="margin-bottom: 10px;">
                <label style="display: block; font-size: 12px; color: #666; margin-bottom: 5px;">Prix maximum</label>
                <input 
                    type="range" 
                    [(ngModel)]="prix_max" 
                    (change)="filterProduits()"
                    [min]="0" 
                    [max]="prix_max_range"
                    style="width: 100%; max-width: 300px;"
                />
                <span style="font-size: 12px; color: #666;">{{ prix_max | number:'1.0-0' }} Ar</span>
            </div>
        </div>

        <!-- Bouton Réinitialiser -->
        <div>
            <button 
                (click)="resetFilter()" 
                style="padding: 8px 15px; background-color: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;"
            >
                Réinitialiser les filtres
            </button>
        </div>
        
        <p *ngIf="isFiltering || isLoadingSpecial" style="margin-top: 10px; color: #007bff; font-size: 14px;">
            <strong *ngIf="!isLoadingSpecial">Résultats :</strong> 
            <strong *ngIf="isLoadingSpecial">Chargement...</strong>
            {{ filteredProduits.length }} produit(s) / {{ produits.length }} total
        </p>
    </div>

    <!-- Message si aucun produit -->
    <div *ngIf="filteredProduits.length === 0" style="text-align: center; padding: 40px;">
        <p style="font-size: 16px; color: #666;">
            {{ isFiltering ? 'Aucun produit ne correspond à vos critères' : 'Aucun produit disponible' }}
        </p>
    </div>

    <!-- Tableau des produits -->
    <div class="glass-card overflow-hidden" *ngIf="filteredProduits.length > 0">
        <table class="modern-table">
            <thead>
                <tr>
                    <th>Image</th>
                    <th>Nom</th>
                    <th>Boutique</th>
                    <th>Description</th>
                    <th>Prix</th>
                    <th>Stock</th>
                    <th>Type</th>
                    <th>Livraison</th>
                    <th *ngIf="isAdmin || isAcheteur">Actions</th>
                </tr>
            </thead>

            <tbody>
                @for (produit of filteredProduits; track produit._id) {
                <tr>
                    <td class="td-image" style="position: relative;">
                        <img [src]="produit.image_preview || ('http://localhost:5000/' + produit.image_Url)"
                            alt="Image du produit" class="product-thumb" />
                        
                        <!-- AFFICHER PLUSIEURS BADGES -->
                        <div style="position: absolute; top: 5px; right: 5px; display: flex; flex-direction: column; gap: 3px;">
                            @for (badge of getProductBadges(produit); track badge.text) {
                                <span style="
                                    background-color: {{ badge.color }}; 
                                    color: {{ badge.color === '#ffc107' ? 'black' : 'white' }}; 
                                    padding: 2px 6px; 
                                    border-radius: 3px; 
                                    font-size: 10px; 
                                    font-weight: bold;
                                    text-shadow: 0 1px 2px rgba(0,0,0,0.2);
                                    white-space: nowrap;
                                ">
                                    {{ badge.text }}
                                </span>
                            }
                        </div>
                    </td>
                    <td class="font-bold">
                    <a [routerLink]="['/produits', produit._id]" style="color: #007bff; text-decoration: none;">
                        {{ produit.nom_prod }}
                    </a>
                    </td>
                    <td>{{ produit.store_id?.name || 'Boutique inconnue' }}</td>
                    <td class="td-desc">{{ produit.descriptions }}</td>
                    <td class="price-cell">
                        {{ produit.prix_unitaire.$numberDecimal | number:'1.0-0' }} Ar
                    </td>
                    <td>
                        <span class="badge" [ngClass]="produit.stock_etat ? 'badge-success' : 'badge-danger'">
                            {{ produit.stock_etat ? 'Disponible' : 'Rupture' }}
                        </span>
                    </td>
                    <td>{{ produit.type_produit }}</td>
                    <td>{{ produit.livraison?.disponibilite ? 'Oui' : 'Non' }}</td>
                    <td *ngIf="isAdmin" class="actions-cell">
                        <button [routerLink]="['/produits/modifier', produit._id]" class="btn-icon" title="Modifier">
                            <img src="/img/svg/icon-update.svg" alt="Modifier">
                        </button>
                        <button (click)="deleteProduit(produit._id)" class="btn-icon btn-delete" title="Supprimer">
                            <img src="/img/svg/icon-delete.svg" alt="Supprimer">
                        </button>
                    </td>
                    <td *ngIf="isAcheteur">
                        <button (click)="addToPanier(produit)" class="btn-icon-buy" title="Ajouter au Panier">
                            <i class="fas fa-cart-plus"></i> <img src="/img/svg/icon-cart.svg" alt="Ajouter au Panier">
                        </button>
                    </td>
                </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<script src=""></script>