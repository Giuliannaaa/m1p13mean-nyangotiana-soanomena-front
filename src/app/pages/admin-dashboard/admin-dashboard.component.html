<div class="dashboard-container">
    <div class="dashboard-header">
        <h1 class="dashboard-title">
            <span class="icon">
                <img src="/img/svg/icon-dashboard.svg" alt="Dashboard">
            </span>
            Tableau de Bord Administrateur
        </h1>
        <p class="dashboard-subtitle">Vue d'ensemble des statistiques de la plateforme</p>
    </div>

    <!-- Loading State -->
    <div *ngIf="loading" class="loading-container">
        <div class="spinner"></div>
        <p class="loading-text">Chargement des donn√©es...</p>
    </div>

    <!-- Error State -->
    <div *ngIf="error && !loading" class="error-container">
        <div class="error-card">
            <span class="error-icon">‚ö†Ô∏è</span>
            <h3>Erreur</h3>
            <p>{{ error }}</p>
            <button class="retry-btn" (click)="loadDashboardData()">
                <span class="btn-icon">üîÑ</span>
                R√©essayer
            </button>
        </div>
    </div>

    <!-- Dashboard Content -->
    <div *ngIf="dashboardData && !loading" class="dashboard-content">

        <!-- Main Stats Grid -->
        <div class="stats-grid">

            <!-- Active Stores Card -->
            <div class="stat-card active-stores">
                <div class="card-header">
                    <div class="icon-wrapper stores-icon">
                        <span class="card-icon">
                            <img src="/img/svg/icon-store.svg" alt="Store">
                        </span>
                    </div>
                    <div class="card-badge active">Actif</div>
                </div>
                <div class="card-body">
                    <h2 class="stat-number">{{ dashboardData.activeStores }}</h2>
                    <p class="stat-label">Boutiques Actives</p>
                    <div class="stat-footer">
                        <span class="total-label">Total: {{ dashboardData.totalStores }}</span>
                        <span class="percentage"
                            [class.high]="getPercentage(dashboardData.activeStores, dashboardData.totalStores) >= 70"
                            [class.medium]="getPercentage(dashboardData.activeStores, dashboardData.totalStores) >= 40 && getPercentage(dashboardData.activeStores, dashboardData.totalStores) < 70"
                            [class.low]="getPercentage(dashboardData.activeStores, dashboardData.totalStores) < 40">
                            {{ getPercentage(dashboardData.activeStores, dashboardData.totalStores) }}%
                        </span>
                    </div>
                </div>
                <div class="card-glow stores-glow"></div>
            </div>

            <!-- Active Buyers Card -->
            <div class="stat-card active-buyers">
                <div class="card-header">
                    <div class="icon-wrapper buyers-icon">
                        <span class="card-icon">
                            <img src="/img/svg/icon-buyer.svg" alt="Buyer">
                        </span>
                    </div>
                    <div class="card-badge active">Actif</div>
                </div>
                <div class="card-body">
                    <h2 class="stat-number">{{ dashboardData.activeBuyers }}</h2>
                    <p class="stat-label">Acheteurs Actifs</p>
                    <div class="stat-footer">
                        <span class="total-label">Total: {{ dashboardData.totalBuyers }}</span>
                        <span class="percentage"
                            [class.high]="getPercentage(dashboardData.activeBuyers, dashboardData.totalBuyers) >= 70"
                            [class.medium]="getPercentage(dashboardData.activeBuyers, dashboardData.totalBuyers) >= 40 && getPercentage(dashboardData.activeBuyers, dashboardData.totalBuyers) < 70"
                            [class.low]="getPercentage(dashboardData.activeBuyers, dashboardData.totalBuyers) < 40">
                            {{ getPercentage(dashboardData.activeBuyers, dashboardData.totalBuyers) }}%
                        </span>
                    </div>
                </div>
                <div class="card-glow buyers-glow"></div>
            </div>

            <!-- Active Promotions Card -->
            <div class="stat-card active-promotions" (click)="openModal('promo')">
                <div class="card-header">
                    <div class="icon-wrapper promotions-icon">
                        <span class="card-icon">
                            <img src="/img/svg/icon-gift.svg" alt="Promotion">
                        </span>
                    </div>
                    <div class="card-badge active">Actif</div>
                </div>
                <div class="card-body">
                    <h2 class="stat-number">{{ dashboardData.activePromotions }}</h2>
                    <p class="stat-label">Promotions Actives</p>
                    <div class="stat-footer">
                        <span class="total-label">Total: {{ dashboardData.totalPromotions }}</span>
                        <span class="percentage"
                            [class.high]="getPercentage(dashboardData.activePromotions, dashboardData.totalPromotions) >= 70"
                            [class.medium]="getPercentage(dashboardData.activePromotions, dashboardData.totalPromotions) >= 40 && getPercentage(dashboardData.activePromotions, dashboardData.totalPromotions) < 70"
                            [class.low]="getPercentage(dashboardData.activePromotions, dashboardData.totalPromotions) < 40">
                            {{ getPercentage(dashboardData.activePromotions, dashboardData.totalPromotions) }}%
                        </span>
                    </div>
                </div>
                <div class="card-glow promotions-glow"></div>
            </div>

            <!-- Inactive Boutique Users Card -->
            <div class="stat-card inactive-users" (click)="openModal('inactifUser')">
                <div class="card-header">
                    <div class="icon-wrapper inactive-icon">
                        <span class="card-icon">
                            <img src="/img/svg/icon-alert-2.svg" alt="User">
                        </span>
                    </div>
                    <div class="card-badge inactive">Inactif</div>
                </div>
                <div class="card-body">
                    <h2 class="stat-number">{{ dashboardData.inactiveBoutiqueUsers }}</h2>
                    <p class="stat-label">Utilisateurs boutique inactifs</p>
                    <div class="stat-footer">
                        <span class="alert-label">N√©cessite attention</span>
                    </div>
                </div>
                <div class="card-glow inactive-glow"></div>
            </div>

        </div>

        <!-- Detailed Stats Section -->
        <div class="details-grid">
            <!-- Dans votre dashboard, l√† o√π vous avez revenuePerStore -->
            <div class="chart-card">
                <div class="chart-title">
                    <div class="title-left">
                        <span class="card-icon">
                            <img src="/img/svg/icon-stat.svg" alt="category">
                        </span>
                        <h3>Revenus par boutique</h3>
                    </div>
                </div>
                <form (ngSubmit)="onFilterSubmit()" #filterForm="ngForm">
                    <div class="filters">
                        <select [(ngModel)]="selectedMonth" name="month" class="select-form">
                            <option *ngFor="let m of availableMonths" [value]="m.value">{{ m.label }}</option>
                        </select>
                        <select [(ngModel)]="selectedYear" name="year" class="select-form">
                            <option *ngFor="let y of availableYears" [value]="y">{{ y }}</option>
                        </select>
                        <button type="submit" class="filter-btn">Filtrer</button>
                    </div>
                </form>

                @if(revenuePerStore.length > 0) {
                <canvas #revenueCanvas style="max-height: 265px;"></canvas>
                } @else {
                <div class="empty-state-container">
                    <p class="empty-state">Aucune donn√©e disponible</p>
                </div>
                }
            </div>

            <!-- Store Count By Category -->
            <div class="detail-card">
                <div class="category-title">
                    <span class="card-icon">
                        <img src="/img/svg/icon-category.svg" alt="category">
                    </span>
                    <h3>Boutiques par cat√©gorie</h3>
                </div>
                <div class="chart-container">
                    <div class="category-list">
                        <div class="category-item" *ngFor="let item of storeCountByCategory">
                            <span class="category-name">{{ item.category }}</span>
                            <span class="category-count">{{ item.count }} </span>
                        </div>
                        <div *ngIf="storeCountByCategory.length === 0" class="empty-state">
                            Aucune donn√©e disponible
                        </div>
                    </div>
                </div>
            </div>

            <!-- Top 5 Stores -->
            <div class="detail-card highlight-card">
                <div class="store-rank-title">
                    <span class="card-icon">
                        <img src="/img/svg/icon-trophy.svg" alt="store-rank">
                    </span>
                    <h3>Top 5 meilleures boutiques</h3>
                </div>
                <div class="top-stores-list">
                    <div class="top-store-item" *ngFor="let store of top5Stores; let i = index">
                        <div class="rank">{{ i + 1 }}</div>
                        <div class="store-info">
                            <span class="store-name">{{ store.boutiqueName }}</span>
                            <span class="store-revenue">{{ store.totalOrders }} ventes</span>
                        </div>
                    </div>
                    <div *ngIf="top5Stores.length === 0" class="empty-state">
                        Aucune donn√©e disponible
                    </div>
                </div>
            </div>

        </div>

    </div>

    <!-- ===== MODAL PROPRI√âTAIRE DE BOUTIQUE INACTIFS ===== -->
    <div class="modal-overlay" *ngIf="showInactiveStoresModal" (click)="closeModal()">
        <div class="modal-container" (click)="$event.stopPropagation()">

            <div class="modal-header">
                <div class="modal-title-wrapper">
                    <div class="title-icon-wrapper danger">
                        <img src="img/svg/icon-alert-2.svg" alt="" class="modal-icon">
                    </div>
                    <div>
                        <h2>Comptes non valid√©s</h2>
                        <p class="modal-subtitle">Ces comptes n√©cessitent une action administrative</p>
                    </div>
                </div>
                <button class="modal-close" (click)="closeModal()">
                    <span class="close-icon">‚úï</span>
                </button>
            </div>

            <div class="modal-body">
                <div class="user-list">
                    <div class="user-card" *ngFor="let user of dashboardData?.inactiveBoutiqueUsersData">
                        <div class="user-avatar">
                            <img src="img/svg/icon-inactif-user.svg" alt="">
                        </div>
                        <div class="user-details">
                            <span class="user-full-name">{{ user.lastname }} {{ user.firstname }}</span>
                            <span class="user-email-text">{{ user.email }}</span>
                        </div>
                        <div class="status-indicator">
                            <span class="dot danger"></span>
                            Inactif
                        </div>
                    </div>
                </div>

                <div *ngIf="!dashboardData?.inactiveBoutiqueUsersData?.length" class="empty-modal-state">
                    <p>Aucun utilisateur inactif trouv√©.</p>
                </div>
            </div>

            <div class="modal-footer">
                <div class="modal-summary">
                    <strong>{{ dashboardData?.inactiveBoutiqueUsersData?.length || 0 }}</strong> utilisateur(s)
                    concern√©(s)
                </div>
                <button class="btn-primary-modal" (click)="closeModal()">Fermer</button>
            </div>

        </div>
    </div>

    <!-- ===== MODAL PROMOTIONS ===== -->
    <div class="modal-overlay" *ngIf="showActivePromoModal" (click)="closeModal()">
        <div class="modal-container" (click)="$event.stopPropagation()">

            <div class="modal-header">
                <div class="modal-title-wrapper">
                    <div class="title-icon-wrapper danger">
                        <img src="img/svg/icon-gift.svg" alt="" class="modal-icon">
                    </div>
                    <div>
                        <h2>Promotions</h2>
                    </div>
                </div>
                <button class="modal-close" (click)="closeModal()">
                    <span class="close-icon">‚úï</span>
                </button>
            </div>

            <div class="modal-body">
                <div class="user-list">
                    <div class="user-card" *ngFor="let promo of dashboardData?.activePromotionsData">
                        <img [src]="'http://localhost:5000/' + promo.prod_id?.image_Url" [alt]="promo.prod_id.nom_prod"
                            class="item-thumb" onerror="this.src='img/placeholder.png'">
                        <div class="item-info">
                            <span class="item-name">{{ promo.prod_id.nom_prod }}</span>
                            <span class="item-meta">
                                Code : <strong>{{ promo.code_promo }}</strong>
                            </span>
                            <span class="item-meta">
                                Date limite : <strong>{{ promo.fin | date:'dd/MM/yyyy' }}</strong>
                            </span>
                            <span class="item-meta">
                                Prix : {{ promo.prod_id.prix_unitaire['$numberDecimal'] | number }} Ar
                            </span>
                        </div>
                        <div class="promo-badge-group">
                            <span class="badge badge-promo">
                                {{ promo.type_prom === 'POURCENTAGE' ? '-' + promo.montant['$numberDecimal'] + '%' :
                                promo.montant['$numberDecimal'] + ' Ar' }}
                            </span>
                            <span class="badge" [class.badge-success]="promo.est_Active"
                                [class.badge-muted]="!promo.est_Active">
                                {{ promo.est_Active ? 'Active' : 'Inactive' }}
                            </span>
                        </div>
                    </div>
                </div>

                <div *ngIf="!dashboardData?.activePromotionsData?.length" class="empty-modal-state">
                    <p>Aucune promotion active trouv√©e.</p>
                </div>
            </div>

            <div class="modal-footer">
                <div class="modal-summary">
                    <strong>{{ dashboardData?.activePromotionsData?.length || 0 }}</strong> promotion(s)
                    concern√©(s)
                </div>
                <button class="btn-primary-modal" (click)="closeModal()">Fermer</button>
            </div>

        </div>
    </div>
</div>